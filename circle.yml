dependencies:
  pre:
    - curl -v -L -o cf-cli_amd64.deb 'https://cli.run.pivotal.io/stable?release=debian64&source=github'
    - sudo dpkg -i cf-cli_amd64.deb
    - cf -v

checkout:
  post:
    - git submodule sync
    - git submodule update --init

test:
  override:
  - go test .

deployment:
  staging:
    branch: master
    owner: AusDTO
    commands:
      - cf api https://api.system.staging.digital.gov.au
      - cf auth $CF_STAGING_USER $CF_STAGING_PASSWORD
      - cf target -o dto -s angie-test
      - cf push $CIRCLE_PROJECT_REPONAME-$(git rev-parse --short $CIRCLE_SHA1) --no-start --random-route
      - cf create-service dto-shared-pgsql shared-psql $CIRCLE_PROJECT_REPONAME-$(git rev-parse --short $CIRCLE_SHA1)-db
      - cf bind-service $CIRCLE_PROJECT_REPONAME-$(git rev-parse --short $CIRCLE_SHA1) $CIRCLE_PROJECT_REPONAME-$(git rev-parse --short $CIRCLE_SHA1)-db
      - cf start $CIRCLE_PROJECT_REPONAME-$(git rev-parse --short $CIRCLE_SHA1)
      - curl "https://api.github.com/repos/AusDTO/cf-pgsql-sample-app/issues/1/comments" -d "body:Here is your url "


# notify:
#   - curl -x 'https://github.com/$CIRCLE_PROJECT_REPONAME/*owner/pulls/$/comments' -d '{
#   "body": "Nice change" }'
  # webhooks:
  #   # A list of hook hashes, containing the URL field
  #   - url: https://github.com/$CIRCLE_PROJECT_REPONAME/$owner/pulls/:number/comments
